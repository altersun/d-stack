<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ðŸ¦• I'll guess your number!</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin: 50px;
            background-color: #dcc8c8;
        }
        #message {
            font-size: 24px;
            margin-bottom: 20px;
        }
        button {
            display: block;
            margin: 10px auto;
            padding: 10px 20px;
            font-size: 18px;
            cursor: pointer;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <h2 style="font-size:10vw" id="message">Wait for it...</h2>
    <img src="/static/guessie/nessie.png" alt="Guessie the Nessie!" 
  style="width: 50%;">
    <button id="higher" disabled>Higher</button>
    <button id="correct" disabled>Correct</button>
    <button id="lower" disabled>Lower</button>

    <script>
        function isSecure() {
            return window.location.protocol === 'https:';
        }

        function wsCorrectProtocol(baseWsUrl) {
            return isSecure() ? baseWsUrl.replace('ws:', 'wss:') : baseWsUrl;
        }

        const urlPath = window.location.pathname;
        const match = urlPath.match(/\/guessie(?:\/(\d{1,4}))?/);
        const playAgainStr = "Play again?";
        const correctStr = "Correct";

        let number = 100; // Default value if no number is provided
        if (match && match[1]) {
            number = parseInt(match[1], 10);
        }

        if (number < 10 || number > 1000) {
            document.getElementById("message").innerText = "Number out of range (10-1000).";
            throw new Error("Number out of range.");
        }

        // Tracking variables
        let low_v = 1;
        let high_v = number;
        let correct_v = false;
        let guess_v = null;

        const wsUrl = wsCorrectProtocol(`ws://${window.location.host}/ws/guessie_guess`);
        const messageDiv = document.getElementById("message");
        const buttons = {
            higher: document.getElementById("higher"),
            correct: document.getElementById("correct"),
            lower: document.getElementById("lower")
        };

        function setButtonsEnabled(state) {
            Object.values(buttons).forEach(button => button.disabled = !state);
        }

        function jsonify_values() {
            var obj = {
                high: high_v,
                low: low_v,
                correct: correct_v
            }
            return JSON.stringify(obj)
        }

        function correct_handler() {
            buttons.lower.disabled = true;
            buttons.higher.disabled = true;
            buttons.correct.disabled = false;
            buttons.correct.textContent = playAgainStr;
            low_v = 1;
            high_v = number;
            correct_v = false;
            guess_v = null;
        }
    

        function request_guess() {
            const ws = new WebSocket(wsUrl);

            ws.addEventListener('open', () => {
                console.log('WebSocket connection established');
                jstr = jsonify_values();
                console.log('Sendnding: ', jstr);
                ws.send(jsonify_values());
                setButtonsEnabled(false);
            });

            // Handle incoming messages
            ws.addEventListener('message', (event) => {
                console.log('Received message : ', event.data);
                if (isNaN(event.data)) {
                    // Non-number sent when correct
                    correct_handler();
                } else {
                    guess_v = parseInt(event.data);
                    setButtonsEnabled(true);
                }
                messageDiv.innerText = event.data;
                ws.close(); // Close the WebSocket after receiving the message
                    
            });

            // Handle errors
            ws.addEventListener('error', (error) => {
                console.error('WebSocket error:', error);
                ws.close(); // Ensure WebSocket is closed on error
                if (buttons.correct.textContent != playAgainStr) {
                    setButtonsEnabled(true);
                }
            });

            // Handle WebSocket close event
            ws.addEventListener('close', () => {
                console.log('WebSocket connection closed.');
                if (buttons.correct.textContent != playAgainStr) {
                    setButtonsEnabled(true);
                }
            });

        }

        window.onload = function() {
            request_guess();
        };

        buttons.higher.addEventListener("click", () => {
            if (high_v == low_v) {
                low_v = guess_v;
            } else {
                low_v = guess_v + 1;
            }
            
            request_guess();
        });

        buttons.lower.addEventListener("click", () => {
            if (high_v == low_v) {
                high_v = guess_v;
            } else {
                high_v = guess_v - 1;
            }
            request_guess();
        });

        buttons.correct.addEventListener("click", () => {
            if (buttons.correct.textContent == playAgainStr) {
                // Start new game
                buttons.correct.textContent = correctStr;
                setButtonsEnabled(true);
            } else {
                correct_v = true;
            }
            request_guess();
        });

        



    </script>
</body>
</html>
