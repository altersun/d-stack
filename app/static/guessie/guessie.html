<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>I'll guess your number</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin: 50px;
        }
        #message {
            font-size: 24px;
            margin-bottom: 20px;
        }
        button {
            display: block;
            margin: 10px auto;
            padding: 10px 20px;
            font-size: 18px;
            cursor: pointer;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div id="message">Wait for it...</div>
    <button id="higher" disabled>Higher</button>
    <button id="correct" disabled>Correct</button>
    <button id="lower" disabled>Lower</button>

    <script>
        function isSecure() {
            return window.location.protocol === 'https:';
        }

        function wsCorrectProtocol(baseWsUrl) {
            return isSecure() ? baseWsUrl.replace('ws:', 'wss:') : baseWsUrl;
        }

        const urlPath = window.location.pathname;
        const match = urlPath.match(/\/guessie(?:\/(\d{1,4}))?/);

        let number = 100; // Default value if no number is provided
        if (match && match[1]) {
            number = parseInt(match[1], 10);
        }

        if (number < 10 || number > 1000) {
            document.getElementById("message").innerText = "Number out of range (10-1000).";
            throw new Error("Number out of range.");
        }

        // Tracking variables
        let low_v = 1;
        let high_v = number;
        let correct_v = false;
        let guess_v = null;

        const wsUrl = wsCorrectProtocol(`ws://${window.location.host}/ws/guessie_guess`);
        const messageDiv = document.getElementById("message");
        const buttons = {
            higher: document.getElementById("higher"),
            correct: document.getElementById("correct"),
            lower: document.getElementById("lower")
        };

        function setButtonsEnabled(state) {
            Object.values(buttons).forEach(button => button.disabled = !state);
        }

        function handleResponse(response) {
            console.log(`Received: ${response}`)
            messageDiv.innerText = response;
            setButtonsEnabled(true);
        }

        function jsonify_values() {
            var obj = {
                high: high_v,
                low: low_v,
                correct: false
            }
            return JSON.stringify(obj)
        }

        function request_guess() {
            const ws = new WebSocket(wsUrl);

            ws.addEventListener('open', () => {
                console.log('WebSocket connection established');
                ws.send(jsonify_values());
                setButtonsEnabled(false)
            });

            // Handle incoming messages
            ws.addEventListener('message', (event) => {
                console.log('Received message : ', event.data)
                guess_v = parseInt(event.data)
                ws.close(); // Close the WebSocket after receiving the message
                    
            });

            // Handle errors
            ws.addEventListener('error', (error) => {
                console.error('WebSocket error:', error);
                ws.close(); // Ensure WebSocket is closed on error
                setButtonsEnabled(true)
            });

            // Handle WebSocket close event
            ws.addEventListener('close', () => {
                console.log('WebSocket connection closed.');
                setButtonsEnabled(true)
            });

        }

        window.onload = function() {
            request_guess();
        };

        Object.keys(buttons).forEach(buttonKey => {
            buttons[buttonKey].addEventListener("click", () => {
                setButtonsEnabled(false);
                sendMessage(buttons[buttonKey].innerText);
            });
        });
    </script>
</body>
</html>
